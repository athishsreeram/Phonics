<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Phonics Pronunciation Coach ‚Äì Structured Modules</title>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      max-width: 720px;
      margin: 30px auto;
      padding: 20px;
      background: #f9f9fb;
      color: #1a1a2e;
      line-height: 1.5;
    }
    h1 { text-align: center; color: #0d47a1; margin-bottom: 0.3em; }
    h2 { color: #1565c0; text-align: center; }
    #word-select {
      text-align: center;
      margin: 25px 0 35px;
    }
    select, button {
      font-size: 1.1rem;
      padding: 12px 24px;
      margin: 8px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    select {
      padding: 12px 20px;
      background: white;
      border: 1px solid #ccc;
      width: 300px;
    }
    optgroup { font-weight: bold; color: #333; }
    button {
      background: #1976d2;
      color: white;
      transition: background 0.2s;
    }
    button:hover:not(:disabled) { background: #1565c0; }
    button:disabled { background: #aaa; cursor: not-allowed; }
    #controls { text-align: center; margin: 30px 0; }
    #target {
      font-size: 3.5rem;
      font-weight: bold;
      text-align: center;
      margin: 20px 0 30px;
      letter-spacing: 5px;
      color: #e65100;
      text-transform: uppercase;
    }
    #result {
      min-height: 260px;
      margin-top: 20px;
      padding: 24px;
      border-radius: 12px;
      background: white;
      box-shadow: 0 3px 14px rgba(0,0,0,0.1);
      line-height: 1.6;
    }
    .score {
      font-size: 3.6rem;
      font-weight: bold;
      text-align: center;
      margin: 12px 0;
    }
    .great  { color: #2e7d32; }
    .okay   { color: #f57c00; }
    .poor   { color: #c62828; }
    .emoji  { font-size: 2.5rem; margin: 0 8px; }
    .tip    { color: #555; font-style: italic; margin-top: 16px; }
    .feedback-item { margin: 10px 0; font-size: 1.1rem; }
  </style>
</head>
<body>

<h1>Phonics Pronunciation Coach</h1>
<h2>Structured by Teaching Modules & Days</h2>

<div id="word-select">
  <label for="wordSelect">Choose a word to practise: </label><br>
  <select id="wordSelect">
    <!-- Module 1: Basic Code (1 letter = 1 sound) -->
    <optgroup label="Module 1 ‚Äì Basic Code (Days 1‚Äì26)">
      <option value="sat">sat (s,a,t ‚Äì Days 1‚Äì5)</option>
      <option value="pat">pat (p,i)</option>
      <option value="pin">pin (p,i,n)</option>
      <option value="mat">mat (m,a,t)</option>
      <option value="dog">dog (d,o,g)</option>
      <option value="cat">cat (c,a,t)</option>
      <option value="kit">kit (k,i,t)</option>
      <option value="rug">rug (r,u,g)</option>
      <option value="hat">hat (h,a,t)</option>
      <option value="bat">bat (b,a,t)</option>
      <option value="fan">fan (f,a,n)</option>
      <option value="lip">lip (l,i,p)</option>
      <option value="jam">jam (j,a,m)</option>
      <option value="van">van (v,a,n)</option>
      <option value="win">win (w,i,n)</option>
      <option value="box">box (x,o)</option>
      <option value="yes">yes (y,e,s)</option>
      <option value="zip">zip (z,i,p)</option>
      <option value="quiz">quiz (qu,i,z)</option>
    </optgroup>

    <!-- Module 2: Consonant Digraphs -->
    <optgroup label="Module 2 ‚Äì Consonant Digraphs (Days 27‚Äì34)">
      <option value="ship">ship (sh)</option>
      <option value="chin">chin (ch)</option>
      <option value="thin">thin (th unvoiced)</option>
      <option value="this">this (th voiced)</option>
      <option value="wheel">wheel (wh)</option>
      <option value="ring">ring (ng)</option>
      <option value="back">back (ck)</option>
      <option value="phone">phone (ph)</option>
    </optgroup>

    <!-- Module 3: Consonant Blends -->
    <optgroup label="Module 3 ‚Äì Consonant Blends (Days 35‚Äì54)">
      <option value="black">black (bl)</option>
      <option value="clap">clap (cl)</option>
      <option value="flag">flag (fl)</option>
      <option value="glue">glue (gl)</option>
      <option value="play">play (pl)</option>
      <option value="slip">slip (sl)</option>
      <option value="bread">bread (br)</option>
      <option value="crab">crab (cr)</option>
      <option value="drum">drum (dr)</option>
      <option value="frog">frog (fr)</option>
      <option value="green">green (gr)</option>
      <option value="tree">tree (tr)</option>
      <option value="skip">skip (sk)</option>
      <option value="stop">stop (st)</option>
      <option value="swim">swim (sw)</option>
    </optgroup>

    <!-- Module 4: Long Vowels & Magic E -->
    <optgroup label="Module 4 ‚Äì Long Vowels & Magic E (Days 55‚Äì68)">
      <option value="cake">cake (a_e)</option>
      <option value="kite">kite (i_e)</option>
      <option value="rope">rope (o_e)</option>
      <option value="mule">mule (u_e)</option>
      <option value="rain">rain (ai)</option>
      <option value="play">play (ay)</option>
      <option value="tree">tree (ee)</option>
      <option value="leaf">leaf (ea)</option>
      <option value="night">night (igh)</option>
      <option value="fly">fly (y long i)</option>
      <option value="boat">boat (oa)</option>
      <option value="snow">snow (ow long o)</option>
      <option value="blue">blue (ue)</option>
      <option value="stew">stew (ew)</option>
    </optgroup>

    <!-- Module 5: Diphthongs & Bossy R -->
    <optgroup label="Module 5 ‚Äì Diphthongs & Bossy R (Days 69‚Äì77)">
      <option value="book">book (oo short)</option>
      <option value="moon">moon (oo long)</option>
      <option value="coin">coin (oi)</option>
      <option value="boy">boy (oy)</option>
      <option value="out">out (ou)</option>
      <option value="cow">cow (ow diphthong)</option>
      <option value="car">car (ar)</option>
      <option value="fork">fork (or)</option>
      <option value="her">her (er)</option>
      <option value="bird">bird (ir)</option>
      <option value="surf">surf (ur)</option>
    </optgroup>

    <!-- Module 6: Advanced & Tricky -->
    <optgroup label="Module 6 ‚Äì Advanced & Tricky Code (Days 78‚Äì84)">
      <option value="city">city (soft c)</option>
      <option value="giant">giant (soft g)</option>
      <option value="knee">knee (kn silent)</option>
      <option value="write">write (wr silent)</option>
      <option value="match">match (tch)</option>
      <option value="bridge">bridge (dge)</option>
      <option value="about">about (schwa)</option>
    </optgroup>
  </select>
</div>

<div id="target">‚Äî select a word ‚Äî</div>

<div id="controls">
  <button id="startBtn">üé§ Start Recording</button>
  <button id="stopBtn" disabled>‚èπÔ∏è Stop & Score</button>
</div>

<div id="result"></div>

<script>
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const PHONICS_RULES = [
  // (same as previous version - kept unchanged for brevity; paste the full PHONICS_RULES array from the last code here)
  // Basic single letters ...
  { pattern: /s/i,          sound: "s",               good: ["s","ss"],            bad: ["z","sh"],                  example: "sun" },
  { pattern: /a(?![e])/i,   sound: "short a",         good: ["a"],                 bad: ["ay","ai","ar"],            example: "cat" },
  // ... include ALL the rules from the previous message
  // (to save space here, assume the full array is copied in)
];

// Scoring constants - adjusted to prioritize word match
const MAX_SCORE = 100;
const WORD_MATCH_PERFECT_BONUS = 60;     // big reward for exact match
const WORD_MATCH_CLOSE_BONUS = 30;       // partial for similar
const WORD_MATCH_THRESHOLD = 0.85;       // ~85% char similarity for "close"
const SOUND_CORRECT_BONUS = 8;           // smaller per sound now
const SOUND_WRONG_DEDUCTION = 12;
const SOUND_MISSING_DEDUCTION = 10;
const BASE_SCORE_IF_NO_MATCH = 40;       // floor when word is completely wrong

let recognition = null;
let isRecording = false;

const startBtn   = document.getElementById("startBtn");
const stopBtn    = document.getElementById("stopBtn");
const resultEl   = document.getElementById("result");
const targetEl   = document.getElementById("target");
const wordSelect = document.getElementById("wordSelect");

let currentWord = "sat";
let currentDisplay = "s a t";

function updateTarget() {
  const selected = wordSelect.options[wordSelect.selectedIndex];
  currentWord = selected.value.toLowerCase();
  currentDisplay = currentWord.split('').join(' ');
  targetEl.textContent = currentDisplay;
  resultEl.innerHTML = '';
}

wordSelect.addEventListener('change', updateTarget);
updateTarget();

// Simple similarity function (Levenshtein-like normalized)
function wordSimilarity(a, b) {
  if (a === b) return 1;
  const longer = a.length > b.length ? a : b;
  const shorter = a.length > b.length ? b : a;
  if (longer.length === 0) return 1;
  let longerMap = {};
  for (let i = 0; i < longer.length; i++) {
    longerMap[longer.charAt(i)] = (longerMap[longer.charAt(i)] || 0) + 1;
  }
  let match = 0;
  for (let i = 0; i < shorter.length; i++) {
    const c = shorter.charAt(i);
    if (longerMap[c] > 0) {
      match++;
      longerMap[c]--;
    }
  }
  return match / longer.length;
}

function initSpeechRecognition() {
  if (!('SpeechRecognition' in window) && !('webkitSpeechRecognition' in window)) {
    resultEl.innerHTML = `<p style="color:#c62828">Speech Recognition not supported.<br>Use Chrome / Edge.</p>`;
    startBtn.disabled = true;
    return false;
  }
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  recognition = new SpeechRecognition();
  recognition.continuous = false;
  recognition.interimResults = false;
  recognition.lang = "en-US";
  return true;
}

function scorePronunciation(transcript) {
  const spoken = transcript.toLowerCase().trim();
  let feedback = [];
  let score = 0;

  // 1. Primary: Word match score (most important)
  const similarity = wordSimilarity(currentWord, spoken.replace(/\s+/g, ''));
  let wordScore = BASE_SCORE_IF_NO_MATCH;
  let wordFeedback = "";

  if (spoken === currentWord || spoken.replace(/\s+/g, '') === currentWord) {
    wordScore = MAX_SCORE;
    wordFeedback = `üèÜ Perfect match ‚Äì you said <b>${currentWord}</b> exactly!`;
    score += WORD_MATCH_PERFECT_BONUS;
  } else if (similarity >= WORD_MATCH_THRESHOLD || spoken.includes(currentWord)) {
    wordScore = 70 + Math.round((similarity - WORD_MATCH_THRESHOLD) * 300);
    wordFeedback = `üü° Close! You said <b>"${spoken}"</b> (target: <b>${currentWord}</b>)`;
    score += WORD_MATCH_CLOSE_BONUS;
  } else {
    wordFeedback = `üî¥ Not quite ‚Äì you said <b>"${spoken}"</b> instead of <b>${currentWord}</b>`;
  }

  feedback.push(`<b>Word accuracy:</b> ${wordFeedback}`);

  // 2. Secondary: Individual sounds (only if word is reasonably close)
  const relevantRules = PHONICS_RULES.filter(rule => rule.pattern.test(currentWord));
  let soundCount = relevantRules.length || 1;
  let soundPoints = 0;

  if (similarity > 0.5) {  // only judge sounds if word is not totally off
    relevantRules.forEach(rule => {
      const hasGood = rule.good.some(g => spoken.includes(g.toLowerCase()));
      const hasBad  = rule.bad.some(b => spoken.includes(b.toLowerCase()));

      if (hasGood) {
        feedback.push(`üü¢ Great <b>"${rule.sound}"</b> sound!`);
        soundPoints += SOUND_CORRECT_BONUS;
      } else if (hasBad) {
        const badFound = rule.bad.find(b => spoken.includes(b.toLowerCase())) || "?";
        feedback.push(`üî¥ <b>"${rule.sound}"</b> ‚Üí said <b>"${badFound}"</b>`);
        soundPoints -= SOUND_WRONG_DEDUCTION;
      } else {
        feedback.push(`üü° <b>"${rule.sound}"</b> unclear/missing`);
        soundPoints -= SOUND_MISSING_DEDUCTION;
      }
    });
  } else {
    feedback.push(`<span class="tip">Word too different ‚Äì focusing on whole-word match first.</span>`);
  }

  // Combine
  score += Math.round(soundPoints * (soundCount > 0 ? 40 / (soundCount * 10) : 0)); // scale sound impact
  score = Math.max(0, Math.min(MAX_SCORE, Math.round(score + wordScore)));

  // Rating
  let overall = "";
  let emoji = "";
  if (score >= 85) {
    overall = "<span class='great'>Excellent!</span>";
    emoji = "üåüüåüüåü";
  } else if (score >= 65) {
    overall = "<span class='okay'>Good effort!</span>";
    emoji = "üëçüëç";
  } else {
    overall = "<span class='poor'>Keep practising!</span>";
    emoji = "üí™";
  }

  let html = `
    <div class="score">${score}%</div>
    <div style="text-align:center; font-size:1.5rem; margin-bottom:16px;">
      ${emoji} <b>Pronunciation Score: ${score}%</b> ‚Äî ${overall}
    </div>
    <hr style="border:none; border-top:1px solid #eee; margin:20px 0;">
  `;

  feedback.forEach(item => html += `<div class="feedback-item">${item}</div>`);

  if (currentWord === "about") {
    html += `<div class="tip">Schwa (/…ô/) is the unstressed "uh" sound ‚Äì focus on natural flow.</div>`;
  }

  html += `<div class="tip" style="margin-top:16px;">You said: <i>"${transcript}"</i></div>`;

  return html;
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
startBtn.onclick = () => {
  if (!recognition && !initSpeechRecognition()) return;

  resultEl.innerHTML = `<p style="color:#555; text-align:center;">Listening‚Ä¶ say <b>${currentWord}</b> clearly</p>`;
  startBtn.disabled = true;
  stopBtn.disabled = false;
  isRecording = true;

  recognition.start();

  recognition.onresult = (event) => {
    const transcript = event.results[0][0].transcript.trim();
    resultEl.innerHTML = scorePronunciation(transcript);
  };

  recognition.onerror = (event) => {
    resultEl.innerHTML = `<p style="color:#c62828">Error: ${event.error}</p>`;
    resetButtons();
  };

  recognition.onend = () => {
    if (isRecording && startBtn.disabled) recognition.start();
    else resetButtons();
  };
};

stopBtn.onclick = () => {
  if (recognition) recognition.stop();
  isRecording = false;
  resetButtons();
};

function resetButtons() {
  startBtn.disabled = false;
  stopBtn.disabled = true;
}

</script>

</body>
</html>